# 社内システム/ツールの開発

開発を補助するシステム/ツールの作成を行った。

---

## 機能レベルでのチェックツール(2013/11〜)

システムが提供している機能が正しく機能しているかをチェックするためのツールを作成した。

### 背景

オペレーションチームから、以下のような問題を解決できないか相談を受けた。

- コンポーネントAとコンポーネントBを含むシステムが提供する機能が正しく動いていない(ex. REST APIがstatus 4xx/5xx)
   - コンポーネントAとコンポーネントBはヘルスチェックレベルで問題なく動いている。
      - L3レベルのヘルスチェック
         - ex. pingに応答する
      - L4レベルのヘルスチェック
         - ex. サービスのポートが開いている
      - L7レベルのヘルスチェック
         - ex. ヘルスチェック用のREST APIがstatus 200を返す
   - 原因例
      - コンポーネントAの設定が間違っており、コンポーネントBを正しく認識していない。
      - コンポーネントBの権限設定が正しく行われておらず、依存するAWSリソースへのアクセスが拒否される。

上記問題の解決のため、『ヘルスチェックよりもアプリケーションに近いレイヤでのチェックをする』ツールが必要であると判断した。

加えて、以下の要件にも対応する必要があった。

- 各環境毎に提供する機能が異なる可能性があるため、実行するチェックを柔軟に組み変えたい。
   - ex. 環境Aでは機能1が提供されているが、環境Bではその機能がサポートされていない。

### 技術スタックと選定理由

- Java: v1
   - QAが既に作成しているインテグレーションテスト(Java)を流用して作成した。
      - 『機能を保証するために必要な最低限のテスト』を選定し、別プロジェクトに切り出した。
   - 目的は達成できたが、実際に運用した結果、以下に示す問題があることが分かった。
      - 実行にかかる時間が長い
         - ビルド時間が支配的だった
      - 環境毎にブランチを作成して、不必要なテスト(=サポートしていない機能に関するテスト)を適宜削除する必要があった。
         - 共通部の変更は全てのブランチをアップデートする必要があり手間がかかる。
- Python: v2
   - v1で発生した問題を解決するものとして作成した。
      - インタプリタ言語にしたため、ビルドが不要になり実行にかかる時間は削減された。
         - チェック内容はREST APIへのアクセスが中心であったため、Java->Pythonに移行したことによるチェック自体の時間増加は大きな問題とはならなかった。
      - テストフレームワークとして採用した pytest の機能を活用することで、単一ブランチで複数環境へのテスト実行を可能とした。
         - 各テスト毎に『どのコンポーネントが必要か』『どの機能に関するテストか』などの情報を示すマーカーを付与する。
         - 環境毎の設定ファイルを作成し、その環境がサポートするコンポーネント/機能に関する情報を前述のマーカーで表現し、設定ファイルに記述する。
         - 各テストの実行前に処理されるフックポイントで、テスト実行判定のロジックが実行される。
            - テストに設定されているマーカーが、環境の設定ファイルに全て含まれる場合のみテストを実行する。
         - テストを実行する環境は、コマンドラインにより指定する。

### もたらした改善/成果

- オペレーションチームのデプロイ作業の効率化に寄与した。
   - 以前はデプロイが成功したかを確認するには、インテグレーションテストを流すしかなかった。
      - インテグレーションテストは全てのコンポーネントが存在する前提で書かれているため、デプロイ作業の途中で確認する術がない
      - インテグレーションテストの実行には時間がかかる。
   - このツール以後は、デプロイ作業を分割し都度確認をしながら進めることができるようになった。
      - ex. アップデートするコンポーネントのインスタンスをロードバランサから外しチェックツールで確認、問題なければロードバランサに再接続 => 以降、全てのインスタンスについて同様の作業を繰り返す
- 自身のスキル向上
   - 別のチームに使ってもらう事が前提だったため、ドキュメントは普段以上に整備した。結果として、使用や設定追加だけでなく、その後の機能追加も他者にやってもらえるようになった。
   - ここでpytestに慣れ親しんだことが、この後に増えたサーバのテストにPythonを採用する契機となった。

### 残った/生じた課題

- 自分が想像していたよりも、バージョン差異(2系/3系だけでなくマイナーバージョン(特に2系)の違いでも)やライブラリ依存関係回りで、トラブルを抱えることが多かった。
   - Pythonはベンダリングを(少なくとも言語レベルでは)サポートしていないため、新しい実行環境では上手く動かない、というケースが度々あった。
   - 今実装するとしたら、Docker化を検討するだろう。
   - Golangによるシングルバイナリ化も検討対象に入るか。その場合、pytest相当のテストランナーをどう実現するかが重要になる。

## image-cleaner(2020/09〜)

Registry内のイメージのうち、タグがついていないものを自動で削除するサービス(image-cleaner)を作成した。

### 背景

特定のタグをつけずに(=常にlatestを使用する)コンテナイメージをRegistryに格納する場合、更新の度にタグがついていないイメージが1つ増えることになる。
コスト的には大した問題はないが、無駄であることには違いないため、気付いたタイミングで手動削除を実施していた。

### 技術スタックと選定理由

- Container Registry(GCP)
   - コンテナイメージを格納する
- Cloud Run
   - image-cleanerを実行し、外部に認証付きのRESTエンドポイントを公開する
- Cloud Scheduler
   - Cloud Runにより公開したRESTエンドポイントを一定周期(1回/day)で実行する
- Cloud Build
   - image-cleanerのコンテナイメージをビルドし、Container RegistryにPushする。
   - リポジトリのmainブランチに変更がマージされるのを契機に、ビルドが実行される。
- Golang
   - image-cleanerの実装言語
   - 以下の理由により採用
      - [Container Registryにアクセスするライブラリ](https://github.com/google/go-containerregistry)がGolangで実装されていた
      - [Kubernetesの検証を始める予定](./infra.md#kubernetes上でのテスト実行202011検証中) があり、その前にGolangに関する知識を入れておきたかった。
         - Kubernetes本体や多くの周辺ツールがGolangで実装されており、調査のためにはGolangを読む力が必要になると判断した。

### もたらした改善/成果

- 自身のスキル向上
   - Cloud Runを用いたサービス公開のパターンを確立した。これにより、[後続のサービス](#ci-vacationci-starter202009)の開発がスムーズに進んだ。
   - 採用理由の通り、Golangに関する知識を入れることができ、[Kubernetesの検証](./infra.md#kubernetes上でのテスト実行202011検証中)に生かすことができた。
   - 作成過程で発生した問題を元に、オープンソースへのPRを作成しマージされた。
      - https://github.com/google/go-containerregistry/pull/880

### 残った/生じた課題

- [デプロイパイプラインの構築](#デプロイパイプラインによる社内ドキュメントの自動公開202102) を経験して、そもそもタグがついていないイメージを作らない方が良いという結論に至った。そのため、このサービスは意味の薄いものとなった。
   - GithubのSHAと関連つけたタグをつければ、関連するコードの特定が容易になり障害時の調査がしやすくなる

## ci-vacation/ci-starter(2020/09〜)

以下の2つのサービスを作成し、[GCP上のCI環境](./infra.md#ci環境のクラウド上への移行202004)をGoogleカレンダーの予定に合わせて起動/停止するようにした。

- ci-vacation: このサービスを実行した日が以下のカレンダーに含まれているかを判定する
   - CI環境を停止する日を入れたカレンダー。現在は土日を登録している。
   - 祝日のカレンダー
- ci-starter: ci-vacationの結果を受けて、Compute Engineインスタンスを停止/起動する

### 背景

GCP上のCI環境は、コストの関係で同時実行数を減らすなどの対応をしていた。
しかし他の方法でコストを削減することができれば、同時実行数を戻すという選択肢も取れるのではないかと考えていた。

### 技術スタックと選定理由

- Cloud Run
   - ci-vacation/ci-starterを実行し、外部に認証付きのRESTエンドポイントを公開する
- Cloud Scheduler
   - Cloud Runにより公開したci-starterのRESTエンドポイントを一定周期(1回/day)で実行する
- Cloud Build
   - ci-vacation/ci-starterのコンテナイメージをビルドし、Container RegistryにPushする。
   - リポジトリのmainブランチに変更がマージされるのを契機に、ビルドが実行される。
- Golang
   - ci-vacation/ci-starterの実装言語

### もたらした改善/成果

- CI環境のコストを数千円(/月)削減することに成功した。
   - 検討の結果、現状の同時実行数でもさほど問題ないと判断したため、コストダウンの恩恵に預かることができた。
- 自身のスキル向上
   - Cloud Runを用いたサービス公開のパターンをブラッシュアップすることができた。
      - Cloud Runから別のCloud Runを呼ぶ場合の認可設定
      - Cloud Build上でプライベートリポジトリに置いたGolang moduleを使う設定

### 残った/生じた課題

- ci-vacation: 現状で決め打ちしている以下の項目を、実行時に変更できると応用の幅が広がると考える。
   - 対象とするカレンダー
   - カレンダーに含まれるかの判定対象となる日付
